# 5조 프로젝트 : 라즈베리 파이를 활용한 IoT 기기 해킹

#### 5조 조원
- 산업보안학과 김성규
- 산업보안학과 박대용
- 산업보안학과 이우성

### 사용 기기
 - 라즈베리 파이Zero WH 모델
 - 라즈베리 파이 카메라 제로 v 1.3

## (1) CCTV

- 라즈베리 파이 기기가 IoT CCTV라고 가정하여 프로젝트를 진행했습니다.
- 라즈베리 파이 카메라를 연결하여 camerashot.py 프로그램을 통해 자동으로 30분마다 사진을 촬영하도록 세팅했습니다.
- CCTV 기기 내에 촬영한 파일들이 날짜별로 저장되어 있고
- 사진들이 저장된 파일 내에 백도어 프로그램을 심어놔서 공격자가 SSH 연결을 통해 IoT CCTV 기기에 연결하지 않더라도, 백도어 프로그램이 지정된 IP와 포트의 주소로 공격자가 원할 때 CCTV 기기가 저장하고 있는 사진들을 전송하는 프로그램을 구현했습니다
- 역시 python의 소켓 API를 사용하여 프로그램을 구현했습니다.

### - backdoor.py
##### 2020.05.27
ver 1.0
- CCTV 사진들이 저장된 디렉토리 내에 존재하는 프로그램입니다
- python의 os 라이브러리를 사용하여 자신이 존재하는 디렉토리와 서브디렉토리 정보를 획득한 뒤 해당 디렉토리에 저장된 정보들을 전송하는 프로그램입니다

##### 2020.06.10
ver 1.5

- master.py에서 파일을 전송받을 때 버퍼의 크기 문제로 인해 여러 사진이 하나의 파일로 저장되는 문제를 피드백으로 받았습니다.
- 이를 해결하기 위해서 backdoor.py에서 사진을 보낼 때 사진을 보내기 전에 사진의 크기를 전송하고, master.py는 전달받은 사진의 크기만큼 데이터를 받은 뒤 이를 파일에 저장하고 그 다음 사진을 받는 방법으로 구현했습니다
##### 보완점(To-Do List)
- 원래 목표는 최초 SSH 접속을 통해 사용자의 라즈베리 파이 기기에 backdoor.py 파일을 설치한 다음 
- 추가적인 SSH 접속 없이도 원격지에서 실행되는 master.py 프로그램에서 전송하는 명령을 통해 공격자의 의도대로 IoT 기기에 저장된 사진을 가져오는 프로그램을 설계하는 것이었습니다.
- 하지만 실제로 프로그램을 구현하다보니 IoT 기기가 하나의 공인 IP 내부에서 사설 IP를 사용하고, 이 사설 IP가 언제든지 바뀔 수 있을 뿐만 아니라
- backdoor.py 프로그램에서 사용하는 포트에 대한 포트포워딩 역시 사전에 필요하는 등 부가적으로 설정해야하는 기능들이 있는데 이러한 점들까지 해킹 시나리오 혹은 프로그램 내부에서 해결할 수 있도록 구현해야하는 보완점이 있습니다.

### - master.py
##### 2020.05.27
ver 1.0
- 원격으로 데이터를 전송받는 프로그램입니다
- 1시간에 한 번씩 backdoor.py 프로그램에게 'get' 메시지를 전송하여 백도어가 존재하는 디렉토리의 정보들을 전송받아 저장하는 프로그램입니다.

##### 2020.06.10
ver 1.5
- 여러 장의 사진이 하나의 사진으로 저장되는 문제를 해결하기 위해 backdoor.py로부터 전달받는 사진의 크기를 먼저 전송받은 다음,
그 크기와 recv를 통해 저장하는 데이터의 크기가 같을 때 까지 데이터를 전송받아 파일을 저장하는 방식으로 변경했습니다.
- json과 일반 바이너리를 번갈아가면서 데이터를 주고받는데, 전송 속도의 차이 때문인지 json 데이터 타입을 읽어들여야 할 때 바이너리 데이터가 먼저 도착해서 데이터 타입 에러가 발생하는 경우가 많았습니다.
- 이를 해결하기 위해 코드 중간중간에 time.sleep을 통해 일정 부분 에러 발생을 막아보려고 했지만 아직 안전성 부분에서 완벽하지 않습니다.
##### 보완점(To-Do List)
- 

### - camerashot.py
ver 1.5

- backdoor.py 프로그램에서 사진을 가져올 때 실제로 IoT 기기에서 촬영한 사진을 사용해보기 위해 만든 프로그램입니다.
- 파이썬 파이 카메라 모듈을 사용해서 라즈베리 파이에 연결된 파이 카메라에 명령을 내려서 30분에 한 번씩 10장의 사진을 촬영하는 프로그램입니다.
##### 보완점(To-Do List)
- 최종 발표 프로그램에서는 단순히 사진을 촬영하는 수준까지 프로그램을 구현했습니다.
- 하지만 실제 CCTV라면 사진 촬영이 아닌 영상을 촬영하고, 정해진 시간별로 영상을 저장하는 수준까지 구현을 해야합니다.
- 뿐만 아니라 파이썬의 openCV 라이브러리를 사용해서 라즈베리 파이 내부적으로 영상을 실시간으로 분석해서 등록되지 않거나 낯선 사람의 얼굴이 포착되면 지정된 사용자에게 알림을 보내주는 기능까지 구현을 할 수 있다면 좋을 것 같습니다.

### (2)DoS Attack
#### 1. 중간 발표
- 칼리리눅스를 사용하여 라즈베리 파이 기기가 사용하는 IP와 포트 번호에 Syn flooding attack과 ping of death 공격 실습을 진행했습니다.
- hping3 툴을 활용했으며 와이어샤크를 통해서 공격이 가해지는 피캣을 캡쳐하여 공격 여부를 확인했습니다.
- 라즈베리 파이에 대한 DoS 공격과 더불어 방어에 대한 프로그램을 구현해보면 좋을 것 같다는 피드백

#### 2. 최종 발표
- 조교님이 피드백해주신 Netfilter 라이브러리와 추가적으로 조사했던 Scapy 라이브러리를 바탕으로 공격과 방어 프로그램 구현 등 발전 방향에 대해 고민해보았지만 라즈베리 파이 환경과 netfilter, scapy 라이브러리에 대한 이해 부족으로 최종적으로 직접 프로그램 구현에는 실패했습니다.
- 최종 발표에서는 기존의 DoS 공격과 더불어, 리눅스의 방화벽 툴인 ufw를 사용하여 포트 설정을 하는 과정을 진행하였습니다.

#### 3. 시도했던 경험
##### __ DoS 공격
- airgeddon툴을 활용한 와이파이재밍 공격을 통하여 ip카메라에 대한 무선접속을 불가능하게 만드는 공격
- scapy 라이브러리를 활용한 DoS 공격 프로그램을 라즈베리 파이에 설치해서 IoT 기기를 하나의 좀비컴퓨터로 만들어서 DoS 공격을 원격으로 명령하는 프로그램 

##### __ DoS 방어
- netfilter라이브러리를 활용하여 직접 패킷을 검출하고 드랍하는 Dos 방어 프로그램 구현
- iptables를 활용한 방화벽 설정

### (3) Airconditioner
2020.05.27
ver 1.0
- 라즈베리 파이 기기가 IoT 에어컨이라고 가정하여 만든 프로그램입니다
- 온도 센서 기기가 없어 처음엔 라즈베리 파이 기기 자체에서 웹 크롤링을 통해 기온 정보와 미세먼지
정보를 수집하려고 했습니다
- 하지만 라즈베리 파이 기기와 운영체제의 성능 제한으로 인해(Raspbian Buster Liter) 라즈베리 파이 자체에서 직접 브라우저를 사용하여 웹 크롤링을 실행하는 건 무리라고 판단되어
- 메인 PC(노트북)에서 웹 크롤링을 통해 날씨 정보와 미세먼지 정보를 수집한 뒤(Client)
- 파이썬의 소켓 API를 사용하여 수집한 정보를 라즈베리 파이(Server)에게 전달하는 프로그램을 작성했습니다.
#### - SendWeatherInfo.py

- 메인 PC(노트북)에서 웹 크롤링을 통해 날씨 정보와 미세먼지 정보를 수집해서 라즈베리 파이 기기에서 작동하는 GetData.py 프로그램에게 전송하는 프로그램입니다
#### - GetData.py

- 라즈베리 파이 기기에서 작동하는 프로그램으로 메인 PC에서 작동하는 SendWeatherInfo.py 프로그램에서 전달받은 날씨 정보와 미세먼지 정보를 화면에 출력하는 프로그램입니다.
- 진짜 IoT 기기라면 전달받은 정보를 처리하여 실내 온도를 조정하고 공기 청정을 수행하는 기능까지 구현해야했으나 일단은 컨셉을 전달하기 위해 단순하게 터미널창에 전달받은 정보를 출력하는 수준까지 구현했습니다.

##### 2020.06.10
주제의 모호함때문에 최종 발표에서는 제외하고 프로젝트를 진행하기로 했습니다.

## 시도했지만 실패한 요소
#### 1. 스미싱에 사용할 웹 페이지 및 웹쉘 구현
- 처음 선택한 주제였던 스미싱을 IoT 기기가 존재하는 무선랜의 주소 및 IoT 기기의 IP를 탈취하는 용도로 설정했습니다.
- 완성도 있는 프로젝트를 위해 
- 1) 실제 스미싱처럼 사용자를 조작된 웹 페이지로 유도한 다음
- 2) 웹쉘을 이용해서 사용자가 의도하지 않은 배치 파일을 다운받게 한 다음
- 3) 배치 파일을 실행하여 사용하고 있는 SSID와 PW를 얻은 다음 이를 공격자가 탈취하는 과정
- 1번 ~ 3번까지의 과정을 모두 구현하고 싶었지만 웹 프로그래밍과 웹쉘을 설치하는 것 까지는 능력의 부족으로 구현하지 못했습니다.
- 단순히 사용자 컴퓨터에 저장된 SSID와 PW를 출력하는 배치파일까지만 구현을 할 수 있었습니다.

#### 2. Netfilter 라이브러리와 Scapy 라이브러리
- 조교님의 피드백 과정에서 알게 된 방법으로 기존에 존재하는 방화벽을 이용하지 않고, 직접 라이브러리를 이용하여 일종의 방화벽 프로그램을 구현해보려 했습니다.
- 프로젝트를 위해 여러 정보를 참조하면서 진행을 해 보았지만, 코드 작성과정에서 원인을 알 수 없는 오류가 너무 많이 발생하였고, 조교님들에게 요청을 청하려고 해도 코드와 오류상황에 대한 팀 자체의 이해도가 너무 떨어져 피드백을 수용할 수 없을 것 같다는 판단으로 인해 포기하게 되었습니다.

#### 3. Airgeddon 툴을 활용한 와이파이 재밍 공격
- 실제로 칼리리눅스 상에서 airgeddon툴을 다운받고 실습을 진행해보았으나, 1차적으로 이 툴을 이용해 와이파이재밍 공격을 진행하기 위해서는 칼리리눅스가 무선랜을 인식할 수 있었어야 했습니다.
- 그러나 기존에 노트북에 내장된 무선랜카드를 칼리리눅스가 인식하는 과정이 쉽지 않았고 많은 블로그를 참조한 결과 usb 무선랜 수신기를 이용하면 보다 쉽게 할 수 있다는 사실을 알게 되어 이를 이용해 보았으나 와이파이 최종 연결 단계에만 도달하면 컴퓨터의 동작이 정지해버리는 오류가 발생했습니다.
- 다른 노트북으로도 진행해보았으나 동일한 오류가 발생하여 이 방안을 진행하지 못했습니다.
 
## 프로젝트 보완점(To-Do List)
#### 1. 명료한 프로젝트 주제
- 사이버 물리 시스템 보안이라는 과목의 방향에 맞게 실제로 IoT 기기를 다뤄보고 경험해보자는 생각으로 라즈베리 파이 기기를 프로젝트에서 사용하기로 결정했습니다.
- 하지만 라즈베리 파이는 CPS 보안 과목의 프로젝트를 진행하는 수단으로 사용하고, 결국엔 이 기기를 사용해서 좀 더 확장이 있는 새로운 영역 혹은 주제를 다루고 탐구했어야 했는데 너무 라즈베리 파이 기기 자체를 세팅하고 사용하는 데에 프로젝트가 집중한 점이 아쉽습니다.

#### 2. 시나리오의 구체화
- 발표 초기에 정했던 스미싱이라는 주제를 IoT 기기가 사용중인 무선랜의 SSID와 패스워드를 탈취하는 용도로 변경했지만, 사실상 아무런 보안 조치가 되지 않은 상황에서 공격을 한다는 가정을 깔아놓고 프로젝트를 진행한 만큼 공격 시나리오에 대한 구체화가 부족했습니다.
- 단순히 보안 조치가 되지 않은 상황 뿐만 아니라, 더 다양한 상황에서도 IoT 기기에 침투할 수 있는 시나리오를 구체화하고 또 실제로 구현할 수 있다면 좋을 것 같습니다.

#### 3. 예외처리를 포함한 코드의 완성도
- 라즈베리 파이 기기에 저장된 정보를 가져오는 프로그램에서 주로 파이썬의 소켓 API를 사용했습니다.
- 하지만 파일을 주고받는 과정, 또 클라이언트 프로그램과 서버 프로그램 사이에서의 통신 과정이 매끄럽지 못한 부분이 존재합니다.
- 네트워크와 관련된 프로그래밍인만큼, 어플리케이션에서 다양한 예외상황을 처리할 수 있고 다양한 옵션을 추가해서 완성도 있는 프로그램을 구현할 수 있다면 좋을 것 같습니다.

## 배운 점
#### 1. 라즈베리 파이 기기 세팅 및 실습
- 수업을 수강하기 전에는 그저 개념으로 알았던 라즈베리 파이, 그리고 IoT 기기의 구조에 대해 배울 수 있었습니다.
- 직접 기기를 세팅하고 또 SSH를 통해 직접 구현한 프로그램을 라즈베리 파이에서 실행시켜보면서 IoT 기기의 활용 방안에 대해서도 생각해보게 되었습니다.

#### 2. 파이썬 소켓프로그래밍
- 직접 소켓 프로그래밍을 통해 제작한 프로그램으로 라즈베리 파이 기기와 컴퓨터 사이의 통신을 실행시켜보며 네트워크 프로그래밍을 익힐 수 있었습니다.
- 또한 통신 프로그램을 제작하는 것과 더불어, 프로그램이 실행되기 위해서 포트포워딩과 같은 호스트 사이의 네트워크 설정 역시 프로그램 실행의 과정으로서 고려해야한다는 점 또한 배울 수 있었습니다.

#### 3. IoT 기기의 보안 취약점과 이에 대한 방어 대책
- 프로젝트를 위해 IoT 기기를 공격하는 방안에 대해 고민하다보니 우리 일상에 존재하는 여러 IoT 기기들에 생각보다 여러 취약점이 존재할 수 있고, 이를 통해 다양한 침해와 위협으로까지 이어질 수 있겠다는 걸 알게되었습니다.
- 또한 이를 방어하기 위해 기초적으로 지켜져야 하는 포트 설정, 계정 관리 뿐만 아니라 방화벽과 이에 대한 프로그램 구현에 대해서까지 생각해볼 수 있었습니다.
